name: Deploy Database Schema to Production

# ‚ö†Ô∏è CRITICAL: This workflow must succeed before code can be merged to main
# See CLAUDE.md for branch protection setup instructions

on:
  push:
    branches:
      - main

concurrency:
  group: production-db-deployment
  cancel-in-progress: false

jobs:
  validate-and-deploy-db:
    runs-on: ubuntu-latest
    name: Validate and Deploy Production Database Schema

    # This job status is checked by GitHub branch protection rules
    # If it fails, merging to main is blocked

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install
        continue-on-error: false

      - name: Validate production environment variables
        id: validate-env
        run: |
          echo "üîç Validating production environment variables..."
          ENV_FILE=.env.production.local node validate-env.js
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PROD_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.PROD_SUPABASE_SERVICE_ROLE_KEY }}
          NEXTAUTH_SECRET: ${{ secrets.PROD_NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.PROD_NEXTAUTH_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.PROD_GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}
          OPENAI_API_KEY: ${{ secrets.PROD_OPENAI_API_KEY }}

      - name: Deploy database schema to production
        id: deploy-db
        run: |
          echo "üöÄ Deploying database schema to production..."
          node setup-production-db.js
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PROD_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.PROD_SUPABASE_SERVICE_ROLE_KEY }}

      - name: Verify deployment success
        if: success()
        run: |
          echo "‚úÖ Production database schema deployed successfully"
          echo "üìÖ Deployment timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "üîí Database is now ready for application deployment"
          echo ""
          echo "‚ú® Vercel will now deploy your application code to production"

      - name: Handle deployment failure
        if: failure()
        run: |
          echo "‚ùå PRODUCTION DATABASE DEPLOYMENT FAILED"
          echo ""
          echo "‚ö†Ô∏è  This merge has been blocked by GitHub branch protection rules"
          echo "üîí Your application will NOT be deployed to production"
          echo ""
          echo "What to do:"
          echo "1. Review the error logs above"
          echo "2. Check your Supabase connection"
          echo "3. Verify all environment variables in GitHub Secrets"
          echo "4. Fix the schema issues in setup-production-db.js"
          echo "5. Commit the fix and push again"
          echo ""
          echo "üìñ For help, see: CLAUDE.md ‚Üí Deployment & CI/CD section"
          exit 1

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}'
            const conclusion = status === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED'
            console.log(`Database deployment: ${conclusion}`)
            console.log(`Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`)
