name: Database Schema Validation & Deployment

# Validates and deploys database schema to staging and production environments
# Required for: main, staging branches
# Blocks deployment if validation fails on main

on:
  push:
    branches:
      - main
      - staging

concurrency:
  group: db-deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    name: Determine Target Environment
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      env-file: ${{ steps.env.outputs.env-file }}
      is-production: ${{ steps.env.outputs.is-production }}

    steps:
      - name: Determine environment from branch
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env-file=.env.production.local" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env-file=.env.staging.local" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "env-file=.env.local" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
          fi

  validate-and-deploy-db:
    runs-on: ubuntu-latest
    name: Validate and Deploy Database Schema
    needs: determine-environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        continue-on-error: false

      - name: Set environment secrets
        id: set-secrets
        run: |
          if [[ "${{ needs.determine-environment.outputs.environment }}" == "production" ]]; then
            echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.PROD_SUPABASE_URL }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PROD_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
            echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.PROD_SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
            echo "NEXTAUTH_SECRET=${{ secrets.PROD_NEXTAUTH_SECRET }}" >> $GITHUB_ENV
            echo "NEXTAUTH_URL=${{ secrets.PROD_NEXTAUTH_URL }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_ID=${{ secrets.PROD_GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
            echo "OPENAI_API_KEY=${{ secrets.PROD_OPENAI_API_KEY }}" >> $GITHUB_ENV
          elif [[ "${{ needs.determine-environment.outputs.environment }}" == "staging" ]]; then
            echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.STAGING_SUPABASE_URL }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.STAGING_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
            echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.STAGING_SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
            echo "NEXTAUTH_SECRET=${{ secrets.STAGING_NEXTAUTH_SECRET }}" >> $GITHUB_ENV
            echo "NEXTAUTH_URL=${{ secrets.STAGING_NEXTAUTH_URL }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
            echo "OPENAI_API_KEY=${{ secrets.STAGING_OPENAI_API_KEY }}" >> $GITHUB_ENV
          else
            echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.DEV_SUPABASE_URL }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.DEV_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
            echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.DEV_SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
            echo "NEXTAUTH_SECRET=${{ secrets.DEV_NEXTAUTH_SECRET }}" >> $GITHUB_ENV
            echo "NEXTAUTH_URL=${{ secrets.DEV_NEXTAUTH_URL }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_ID=${{ secrets.DEV_GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.DEV_GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
            echo "OPENAI_API_KEY=${{ secrets.DEV_OPENAI_API_KEY }}" >> $GITHUB_ENV
          fi

      - name: Validate environment variables
        id: validate-env
        run: |
          echo "ðŸ” Validating ${{ needs.determine-environment.outputs.environment }} environment variables..."
          node validate-env.js

      - name: Prepare database schema
        id: deploy-db
        run: |
          echo "ðŸ“‹ Preparing ${{ needs.determine-environment.outputs.environment }} database schema..."
          node setup-production-db.js

      - name: Verify deployment success
        if: success()
        run: |
          echo "âœ… ${{ needs.determine-environment.outputs.environment }} database schema deployed successfully"
          echo "ðŸ“… Deployment timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "ðŸš€ Environment is ready for application deployment"

      - name: Handle deployment failure
        if: failure()
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          UPPER_ENV=$(echo $ENVIRONMENT | tr '[:lower:]' '[:upper:]')

          echo "âŒ $UPPER_ENV DATABASE DEPLOYMENT FAILED" >&2
          echo "" >&2
          echo "What to do:" >&2
          echo "1. Review the error logs above" >&2
          echo "2. Check your Supabase connection" >&2
          echo "3. Verify all environment variables in GitHub Secrets" >&2
          echo "4. Fix the schema issues in setup-production-db.js" >&2
          echo "5. Commit the fix and push again" >&2
          echo "" >&2
          echo "ðŸ“– For help, see: CLAUDE.md â†’ Deployment & CI/CD section" >&2
          exit 1

      - name: Create deployment summary
        if: always()
        run: |
          echo "## Database Schema Deployment ðŸ—„ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ needs.determine-environment.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Validation | ${{ steps.validate-env.outcome == 'success' && 'âœ…' || 'âŒ' }} ${{ steps.validate-env.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Deployment | ${{ steps.deploy-db.outcome == 'success' && 'âœ…' || 'âŒ' }} ${{ steps.deploy-db.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ¨ **All checks passed!** Your application can now be deployed." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Deployment blocked.** Fix the errors above and push again." >> $GITHUB_STEP_SUMMARY
          fi
